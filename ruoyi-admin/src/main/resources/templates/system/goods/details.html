<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('修改商品')"/>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-goods-edit" th:object="${sysGoods}">
        <input name="goodsId" th:field="*{goodsId}" type="hidden">
        <div class="form-group">
            <label class="col-sm-3 control-label">商品名称：</label>
            <div class="col-sm-8">
                <input name="goodsName" th:field="*{goodsName}" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">白名单商品链接：</label>
            <div class="col-sm-8">
                <div style="width: 100%;display: flex;flex-wrap: wrap;">
                    <div class="whiteImg" style="display: flex;flex-wrap: wrap;margin-bottom: 10px;">

                    </div>
                </div>
                <div class="whiteImgUrl" style="display: none;">[[*{whiteImg}]]</div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">黑名单商品链接：</label>
            <div class="col-sm-8">
                <div style="width: 100%;display: flex;flex-wrap: wrap;">
                    <div class="blackImg" style="display: flex;flex-wrap: wrap;margin-bottom: 10px;"></div>

                </div>
                <div class="blackImgUrl" style="display: none;">[[*{blackImg}]]</div>
            </div>
        </div>


        <div class="form-group">
            <label class="col-sm-3 control-label">代码展示：</label>
            <div class="col-sm-8">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal5">生成代码
                </button>
            </div>
        </div>


    </form>
</div>

<div class="modal inmodal fade" id="myModal5" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="tabs-container">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true"> 代码</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="tab-1" class="tab-pane active">
                        <div class="panel-body" id="whiteContent">
                            <p>白名单代码白名单代码白名单代码白名单代码白名单代码白名单代码白名单代码白名单代码白名单代码
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    $("#form-goods-edit").validate({
        focusCleanup: true
    });

    $(function () {
        let whiteImgArr = $('.whiteImgUrl').html().indexOf(',') != -1 ? $('.whiteImgUrl').html().split(',') : [$('.whiteImgUrl').html()];
        let blackImgArr = $('.blackImgUrl').html().indexOf(',') != -1 ? $('.blackImgUrl').html().split(',') : [$('.blackImgUrl').html()];
        let str = '';
        let wcontent = '';
        const goodsId = $('#goodsId').val();
        
        // 白名单链接
        for (var i = 0; i < whiteImgArr.length; i++) {
            if (whiteImgArr[i] && whiteImgArr[i].trim() !== '') {
                str = `<div class="teImg" style="position: relative;margin-right: 10px;margin-bottom: 10px;">
                            <img src="` + whiteImgArr[i] + `" alt="" style="width: 80px;height: 80px;">
                            <p style="width: 200px;word-break: break-all;">` + whiteImgArr[i] + `</p>
                       </div>`;
                $('.whiteImg').append(str);

                // Generate code in the exact format: <p><img src=https://{{host}}/kf/{{goodsId}}+{{i}}.jpg /></p>
                let encodedFilename = btoa(`${goodsId}+${i}`); // Encode only the filename part with base64
                let htmlCode = `<p style="text-align: center" align="center"><img src="https://${window.location.hostname}/kf/${encodedFilename}.jpg" /></p>`;
                wcontent += htmlCode;
            }
        }
        
        // Store the content in a global variable for copying
        window.htmlContentToCopy = wcontent;
        
        // Convert HTML to entities for display
        let displayContent = wcontent.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Create the display and copy button
        $("#whiteContent").html(`
            <pre style="white-space: pre-wrap; word-break: break-all;">${displayContent}</pre>
            <button id="copyCodeBtn" class="btn btn-primary btn-sm" style="margin-top: 10px;">
                复制代码
            </button>
        `);
        
        // Add click event for the copy button
        $("#copyCodeBtn").on("click", function() {
            copyToClipboard(window.htmlContentToCopy);
        });
        
        // Function to copy text to clipboard
        function copyToClipboard(text) {
            // Create a temporary element
            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            
            // Save current selection
            const selected = document.getSelection().rangeCount > 0 
                ? document.getSelection().getRangeAt(0) 
                : false;
            
            // Select the text
            el.select();
            
            // Copy the text
            const success = document.execCommand('copy');
            
            // Remove the temporary element
            document.body.removeChild(el);
            
            // Restore original selection if there was one
            if (selected) {
                document.getSelection().removeAllRanges();
                document.getSelection().addRange(selected);
            }
            
            // Update button text
            if (success) {
                $("#copyCodeBtn").text("已复制!");
                setTimeout(() => { $("#copyCodeBtn").text("复制代码"); }, 2000);
            }
            
            return success;
        }

        // 黑名单链接
        for (var i = 0; i < blackImgArr.length; i++) {
            if (blackImgArr[i] && blackImgArr[i].trim() !== '') {
                str = `<div class="teImg" style="position: relative;margin-right: 10px;margin-bottom: 10px;">
                            <img src="` + blackImgArr[i] + `" alt="" style="width: 80px;height: 80px;">
                            <p style="width: 200px;word-break: break-all;">` + blackImgArr[i] + `</p>
                       </div>`;
                $('.blackImg').append(str);
            }
        }
    });

</script>
</body>
</html>